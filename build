#!/usr/bin/env nix-shell
#!nix-shell -p git -i bash

unset IN_NIX_SHELL

nixpkgs=$(nix eval --raw '(import ./nix/sources.nix).nixpkgs-unstable')

nix-store --realise "$nixpkgs" 2 &>/dev/null

export NIX_PATH=nixpkgs=$nixpkgs:nixos-config=/etc/nixos/configuration.nix
export NIXOS_INSTALL_BOOTLOADER=1

if [[ -n $INSIDE_EMACS ]]; then
  nix-build $nixpkgs/nixos -A system "$@"
else
  nix build -f $nixpkgs/nixos system "$@"
fi &&
  {
    git add .
    git commit -t <(
      echo -n "Update "
      echo -n "$(git diff HEAD --name-only)" | tr "\n" ", "
    ) --no-edit --no-gpg-sign
    git tag latestBuild --force
  }
